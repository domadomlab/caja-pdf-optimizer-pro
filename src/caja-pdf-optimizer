#!/bin/bash
# ==============================================================================
# Caja PDF Optimizer Pro (Linux Edition)
# Version: 3.1.1
# ==============================================================================
# Requirements: imagemagick, ghostscript, libreoffice, libnotify-bin
# ==============================================================================

LOG_FILE="/tmp/pdf_optimizer.log"
DEFAULT_DPI=150

# --- База данных "сканеров" для маскировки (Camouflage) ---
FAKE_PRODUCERS=("HP LaserJet MFP M426fdw" "HP Color LaserJet Pro MFP M283fdw" "Canon iR-ADV C5535" "Canon MF Scan Utility" "Xerox WorkCentre 7845" "Kyocera ECOSYS M2540dn" "Brother MFC-L2710DW" "Epson Scan 2")
FAKE_CREATORS=("HP Scan" "HP Smart" "Canon PDF Platform" "Xerox WorkCentre" "KM-4050 Scanner" "Brother iPrint&Scan" "EPSON Scan")
FAKE_TITLES=("Scanned Document" "Scan" "Doc" "Document" "Scan_$(date +%Y)" "CCF_0001")

# Экспорт дисплея для GUI уведомлений
export DISPLAY="${DISPLAY:-:0}"

# --- Парсинг аргументов ---
if [[ "$1" =~ ^[0-9]+$ ]]; then
    DPI="$1"
    shift
else
    DPI=$DEFAULT_DPI
fi

SUFFIX="_${DPI}dpi"

log_notify() {
    local MSG="$1"
    local TYPE="$2"
    echo "[$(date '+%H:%M:%S')] $MSG" >> "$LOG_FILE"
    
    if [[ "$TYPE" == "gui" ]]; then
        notify-send -i "application-pdf" "PDF Optimizer" "$MSG" 2>/dev/null
    elif [[ "$TYPE" == "error" ]]; then
        notify-send -u critical -i "dialog-error" "PDF Optimizer Error" "$MSG" 2>/dev/null
    fi
}

# Проверка зависимостей
for cmd in convert gs libreoffice notify-send; do
    if ! command -v $cmd &> /dev/null; then
        log_notify "Ошибка: $cmd не установлен!" "error"
        # exit 1 # Не выходим, пробуем работать без части функций
    fi
done

log_notify "=== СТАРТ v3.1.1: $DPI DPI, Файлов: $# ==="

for INPUT_FILE in "$@"; do
    if [ ! -f "$INPUT_FILE" ]; then continue; fi

    DIRNAME=$(dirname "$INPUT_FILE")
    FILENAME=$(basename "$INPUT_FILE")
    EXTENSION="${FILENAME##*.}"
    BASENAME="${FILENAME%.*}"
    
    WORKING_FILE="$INPUT_FILE"
    IS_TEMP_PDF=false

    # --- Поддержка Word/Docx/ODT ---
    if [[ "$EXTENSION" =~ ^(doc|docx|odt)$ ]]; then
        log_notify "Конвертация документа Word: $FILENAME" "info"
        TEMP_PDF="/tmp/temp_$(date +%s)_$BASENAME.pdf"
        libreoffice --headless --convert-to pdf --outdir "/tmp" "$INPUT_FILE" &>> "$LOG_FILE"
        
        # LibreOffice сохраняет в файл с тем же именем, но .pdf в указанный outdir
        LO_OUT="/tmp/$BASENAME.pdf"
        if [ -f "$LO_OUT" ]; then
            mv "$LO_OUT" "$TEMP_PDF"
            WORKING_FILE="$TEMP_PDF"
            IS_TEMP_PDF=true
        else
            log_notify "Ошибка конвертации Word: $FILENAME" "error"
            continue
        fi
    fi

    OUTPUT_FILE="${DIRNAME}/${BASENAME}${SUFFIX}.pdf"
    
    # Генерация случайных метаданных
    RAND_PROD=${FAKE_PRODUCERS[$RANDOM % ${#FAKE_PRODUCERS[@]}]}
    RAND_CREA=${FAKE_CREATORS[$RANDOM % ${#FAKE_CREATORS[@]}]}
    RAND_TITL=${FAKE_TITLES[$RANDOM % ${#FAKE_TITLES[@]}]}

    log_notify "Оптимизация: $FILENAME ($DPI DPI)"

    # Основная команда ImageMagick
    if [ "$DPI" == "030" ] || [ "$DPI" == "30" ]; then
        # Extreme Mode (Quality 40)
        convert -density 150 -units PixelsPerInch "$WORKING_FILE" \
                -alpha remove -alpha off \
                -filter Lanczos -distort Resize 95% \
                -unsharp 0x0.5 \
                -sampling-factor 4:2:0 \
                -compress jpeg -quality 40 \
                +profile "*" \
                -define "pdf:Producer=$RAND_PROD" \
                -define "pdf:Creator=$RAND_CREA" \
                -define "pdf:Title=$RAND_TITL" \
                "$OUTPUT_FILE" >> "$LOG_FILE" 2>&1
    elif [ "$DPI" == "150" ]; then
        # Scientific Email Mode (Trellis Mimic + Quality 70)
        convert -density 150 -units PixelsPerInch "$WORKING_FILE" \
                -alpha remove -alpha off \
                -filter Lanczos -distort Resize 95% \
                -unsharp 0x0.5 \
                -sampling-factor 4:2:0 \
                -compress jpeg -quality 70 \
                +profile "*" \
                -define "pdf:Producer=$RAND_PROD" \
                -define "pdf:Creator=$RAND_CREA" \
                -define "pdf:Title=$RAND_TITL" \
                "$OUTPUT_FILE" >> "$LOG_FILE" 2>&1
    else
        # Other Standard Modes (Eco, Print, High)
        convert -density "$DPI" -units PixelsPerInch "$WORKING_FILE" \
                -alpha remove -alpha off \
                -sampling-factor 4:2:0 \
                -compress jpeg -quality 70 \
                +profile "*" \
                -define "pdf:Producer=$RAND_PROD" \
                -define "pdf:Creator=$RAND_CREA" \
                -define "pdf:Title=$RAND_TITL" \
                "$OUTPUT_FILE" >> "$LOG_FILE" 2>&1
    fi
    
    if [ $? -eq 0 ] && [ -f "$OUTPUT_FILE" ]; then
        OLD_SIZE=$(stat -c%s "$INPUT_FILE")
        NEW_SIZE=$(stat -c%s "$OUTPUT_FILE")
        
        # Расчет процента сжатия
        DIFF=$((OLD_SIZE - NEW_SIZE))
        if [ $OLD_SIZE -gt 0 ]; then
            PCT=$(( 100 * DIFF / OLD_SIZE ))
        else
            PCT=0
        fi

        OLD_SIZE_H=$(du -h "$INPUT_FILE" | cut -f1)
        NEW_SIZE_H=$(du -h "$OUTPUT_FILE" | cut -f1)

        log_notify "Готово: $FILENAME\nСжато на $PCT% ($NEW_SIZE_H)" "gui"
    else
        log_notify "Ошибка обработки: $FILENAME" "error"
    fi

    # Очистка временного PDF
    if [ "$IS_TEMP_PDF" = true ] && [ -f "$WORKING_FILE" ]; then
        rm "$WORKING_FILE"
    fi
done