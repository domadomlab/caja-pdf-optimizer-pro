#!/bin/bash
# ==============================================================================
# Caja PDF Optimizer Pro (Linux Edition)
# Version: 3.6.6 (Stable Menu)
# ==============================================================================

LOG_FILE="/tmp/pdf_optimizer.log"
DEFAULT_DPI=150
SRC_DIR="$(cd "$(dirname "$0")" && pwd)"

# --- DEFINITIONS MUST BE FIRST ---
log_notify() {
    local MSG="$1"; local TYPE="$2"
    echo "[$(date '+%H:%M:%S')] $MSG" >> "$LOG_FILE"
    if [[ "$TYPE" == "gui" ]]; then notify-send -i "application-pdf" "PDF Optimizer" "$MSG" 2>/dev/null
    elif [[ "$TYPE" == "error" ]]; then notify-send -u critical -i "dialog-error" "PDF Optimizer Error" "$MSG" 2>/dev/null; fi
}

# --- Matched Global Scanner Profiles 2024-2025 ---
# Format: "Brand|Producer|Creator"
PROFILES=(
    "Fujitsu|Fujitsu ScanSnap iX1600|ScanSnap Manager"
    "Ricoh|Ricoh IM C4500|Ricoh Scan Router"
    "Konica Minolta|Konica Minolta bizhub C250i|bizhub Scan Service"
    "HP|HP LaserJet Enterprise MFP M776z|HP Scan Extended"
    "Canon|Canon iR-ADV DX C5840i|imageRUNNER ADVANCE"
    "Xerox|Xerox AltaLink C8130|Xerox AltaLink Service"
    "Epson|Epson WorkForce DS-30000|Epson Document Capture"
    "Kyocera|Kyocera ECOSYS M3645dn|Kyocera Quick Scan"
    "Brother|Brother ADS-4700W|Brother ControlCenter4"
)

export DISPLAY="${DISPLAY:-:0}"

if [[ "$1" =~ ^[0-9]+$ ]]; then
    DPI="$1"; shift
else
    DPI=$DEFAULT_DPI
fi

SUFFIX="_${DPI}dpi"

# --- MAIN LOGIC STARTS HERE ---
log_notify "=== СТАРТ v3.6.6: $DPI DPI, Файлов: $# ==="

for INPUT_FILE in "$@"; do
    if [ ! -f "$INPUT_FILE" ]; then continue; fi

    DIRNAME=$(dirname "$INPUT_FILE"); FILENAME=$(basename "$INPUT_FILE")
    EXTENSION="${FILENAME##*.}"; BASENAME="${FILENAME%.*}"
    WORKING_FILE="$INPUT_FILE"; IS_TEMP_PDF=false

    if [[ "$EXTENSION" =~ ^(doc|docx|odt)$ ]]; then
        TEMP_PDF="/tmp/temp_$(date +%s)_$BASENAME.pdf"
        libreoffice --headless --convert-to pdf --outdir "/tmp" "$INPUT_FILE" &>> "$LOG_FILE"
        LO_OUT="/tmp/$BASENAME.pdf"
        if [ -f "$LO_OUT" ]; then mv "$LO_OUT" "$TEMP_PDF"; WORKING_FILE="$TEMP_PDF"; IS_TEMP_PDF=true
        else log_notify "Ошибка конвертации: $FILENAME" "error"; continue; fi
    fi

    OUTPUT_FILE="${DIRNAME}/${BASENAME}${SUFFIX}.pdf"
    PAGE_COUNT=$(pdfinfo "$WORKING_FILE" | grep -a Pages | awk '{print $2}')
    [ -z "$PAGE_COUNT" ] && PAGE_COUNT=1

    log_notify "Оптимизация ($PAGE_COUNT стр.): $FILENAME"

    IM_LIMITS="-limit memory 1GiB -limit map 2GiB -limit area 512MiB -limit disk 16GiB"
    QUALITY=70; READ_DPI=$DPI
    if [ "$DPI" == "030" ] || [ "$DPI" == "30" ]; then QUALITY=40; READ_DPI=150; fi
    
    # Selection of matched profile
    RAND_IDX=$((RANDOM % ${#PROFILES[@]}))
    SELECTED_PROFILE=${PROFILES[$RAND_IDX]}
    BRAND=$(echo $SELECTED_PROFILE | cut -d'|' -f1)
    RAND_PROD=$(echo $SELECTED_PROFILE | cut -d'|' -f2)
    RAND_CREA=$(echo $SELECTED_PROFILE | cut -d'|' -f3)
    TITLES=("Scanned Document" "Scan" "Doc" "Document" "Scan_2026")
    RAND_TITL=${TITLES[$RANDOM % ${#TITLES[@]}]}

    T_DIR="/tmp/pdfopt_$(date +%s)_$BASENAME"
    mkdir -p "$T_DIR"

    META_FILE="$T_DIR/pdfmarks"
    cat > "$META_FILE" <<EOF
[ /Title ($RAND_TITL)
  /Author (Scanner)
  /Creator ($RAND_CREA)
  /DOCINFO pdfmark
EOF

    if [ "$PAGE_COUNT" -gt 1 ]; then
        pdfseparate "$WORKING_FILE" "$T_DIR/p-%04d.pdf"
        CORES=$(nproc)
        count=0
        for page in "$T_DIR"/p-*.pdf; do
            opt_page="$T_DIR/opt-$(basename "$page")"
            convert $IM_LIMITS -density "$READ_DPI" -units PixelsPerInch "$page" \
                    -despeckle -enhance \
                    -alpha remove -alpha off -filter Lanczos -distort Resize 95% \
                    -unsharp 0x0.5 -sampling-factor 4:2:0 -compress jpeg -quality $QUALITY \
                    +profile "*" "$opt_page" >> "$LOG_FILE" 2>&1 &
            count=$((count + 1))
            if [ $((count % CORES)) -eq 0 ]; then wait; fi
        done
        wait
        gs -dNOPAUSE -dBATCH -sDEVICE=pdfwrite -sOUTPUTFILE="$OUTPUT_FILE" "$T_DIR"/opt-p-*.pdf "$META_FILE" &>> "$LOG_FILE"
    else
        OPT_SINGLE="$T_DIR/opt_single.pdf"
        convert $IM_LIMITS -density "$READ_DPI" -units PixelsPerInch "$WORKING_FILE" \
                -despeckle -enhance \
                -alpha remove -alpha off -filter Lanczos -distort Resize 95% \
                -unsharp 0x0.5 -sampling-factor 4:2:0 -compress jpeg -quality $QUALITY \
                +profile "*" "$OPT_SINGLE" >> "$LOG_FILE" 2>&1
        gs -dNOPAUSE -dBATCH -sDEVICE=pdfwrite -sOUTPUTFILE="$OUTPUT_FILE" "$OPT_SINGLE" "$META_FILE" &>> "$LOG_FILE"
    fi
    
    # Patch Producer via Python (Standard lib)
    python3 "$SRC_DIR/pdf_meta.py" "$OUTPUT_FILE" "$RAND_PROD"

    if [ $? -eq 0 ] && [ -f "$OUTPUT_FILE" ]; then
        log_notify "Готово: $FILENAME ($(du -h "$OUTPUT_FILE" | cut -f1))" "gui"
    else log_notify "Ошибка обработки: $FILENAME" "error"; fi

    rm -rf "$T_DIR"
    [ "$IS_TEMP_PDF" = true ] && [ -f "$WORKING_FILE" ] && rm "$WORKING_FILE"
done
