#!/bin/bash
# ==============================================================================
# Caja PDF Optimizer Pro (Linux Edition)
# Version: 3.3.1 (Scientific Parallel)
# ==============================================================================

LOG_FILE="/tmp/pdf_optimizer.log"
DEFAULT_DPI=150

FAKE_PRODUCERS=("HP LaserJet MFP M426fdw" "HP Color LaserJet Pro MFP M283fdw" "Canon iR-ADV C5535" "Canon MF Scan Utility" "Xerox WorkCentre 7845" "Kyocera ECOSYS M2540dn" "Brother MFC-L2710DW" "Epson Scan 2")
FAKE_CREATORS=("HP Scan" "HP Smart" "Canon PDF Platform" "Xerox WorkCentre" "KM-4050 Scanner" "Brother iPrint&Scan" "EPSON Scan")

export DISPLAY="${DISPLAY:-:0}"

if [[ "$1" =~ ^[0-9]+$ ]]; then
    DPI="$1"; shift
else
    DPI=$DEFAULT_DPI
fi

SUFFIX="_${DPI}dpi"

log_notify() {
    local MSG="$1"; local TYPE="$2"
    echo "[$(date '+%H:%M:%S')] $MSG" >> "$LOG_FILE"
    if [[ "$TYPE" == "gui" ]]; then notify-send -i "application-pdf" "PDF Optimizer" "$MSG" 2>/dev/null
    elif [[ "$TYPE" == "error" ]]; then notify-send -u critical -i "dialog-error" "PDF Optimizer Error" "$MSG" 2>/dev/null; fi
}

log_notify "=== СТАРТ v3.3.1 (Parallel Pro): $DPI DPI, Файлов: $# ==="

for INPUT_FILE in "$@"; do
    if [ ! -f "$INPUT_FILE" ]; then continue; fi

    DIRNAME=$(dirname "$INPUT_FILE"); FILENAME=$(basename "$INPUT_FILE")
    EXTENSION="${FILENAME##*.}"; BASENAME="${FILENAME%.*}"
    WORKING_FILE="$INPUT_FILE"; IS_TEMP_PDF=false

    if [[ "$EXTENSION" =~ ^(doc|docx|odt)$ ]]; then
        TEMP_PDF="/tmp/temp_$(date +%s)_$BASENAME.pdf"
        libreoffice --headless --convert-to pdf --outdir "/tmp" "$INPUT_FILE" &>> "$LOG_FILE"
        LO_OUT="/tmp/$BASENAME.pdf"
        if [ -f "$LO_OUT" ]; then mv "$LO_OUT" "$TEMP_PDF"; WORKING_FILE="$TEMP_PDF"; IS_TEMP_PDF=true
        else log_notify "Ошибка конвертации: $FILENAME" "error"; continue; fi
    fi

    OUTPUT_FILE="${DIRNAME}/${BASENAME}${SUFFIX}.pdf"
    PAGE_COUNT=$(pdfinfo "$WORKING_FILE" | grep -a Pages | awk '{print $2}')
    [ -z "$PAGE_COUNT" ] && PAGE_COUNT=1

    log_notify "Оптимизация ($PAGE_COUNT стр.): $FILENAME"

    # Per-thread limits: 512MB RAM, 1GB Map
    IM_LIMITS="-limit memory 512MiB -limit map 1GiB -limit area 256MiB -limit disk 16GiB"
    QUALITY=70; READ_DPI=$DPI
    if [ "$DPI" == "030" ] || [ "$DPI" == "30" ]; then QUALITY=40; READ_DPI=150; fi
    
    # Select ONE random scanner for the WHOLE document
    RAND_PROD=${FAKE_PRODUCERS[$RANDOM % ${#FAKE_PRODUCERS[@]}]}
    RAND_CREA=${FAKE_CREATORS[$RANDOM % ${#FAKE_CREATORS[@]}]}

    if [ "$PAGE_COUNT" -gt 1 ]; then
        T_DIR="/tmp/pdfturbo_$(date +%s)_$BASENAME"
        mkdir -p "$T_DIR"
        pdfseparate "$WORKING_FILE" "$T_DIR/p-%04d.pdf"
        
        CORES=$(nproc)
        count=0
        for page in "$T_DIR"/p-*.pdf; do
            opt_page="$T_DIR/opt-$(basename "$page")"
            convert $IM_LIMITS -density "$READ_DPI" -units PixelsPerInch "$page" \
                    -alpha remove -alpha off -filter Lanczos -distort Resize 95% \
                    -unsharp 0x0.5 -sampling-factor 4:2:0 -compress jpeg -quality $QUALITY \
                    +profile "*" -define "pdf:Producer=$RAND_PROD" -define "pdf:Creator=$RAND_CREA" "$opt_page" >> "$LOG_FILE" 2>&1 &
            
            count=$((count + 1))
            if [ $((count % CORES)) -eq 0 ]; then wait; fi
        done
        wait
        
        pdfunite "$T_DIR"/opt-p-*.pdf "$OUTPUT_FILE" &>> "$LOG_FILE"
        RET_CODE=$?
        rm -rf "$T_DIR"
    else
        convert $IM_LIMITS -density "$READ_DPI" -units PixelsPerInch "$WORKING_FILE" \
                -alpha remove -alpha off -filter Lanczos -distort Resize 95% \
                -unsharp 0x0.5 -sampling-factor 4:2:0 -compress jpeg -quality $QUALITY \
                +profile "*" -define "pdf:Producer=$RAND_PROD" -define "pdf:Creator=$RAND_CREA" "$OUTPUT_FILE" >> "$LOG_FILE" 2>&1
        RET_CODE=$?
    fi
    
    if [ $RET_CODE -eq 0 ] && [ -f "$OUTPUT_FILE" ]; then
        OLD_SIZE=$(stat -c%s "$INPUT_FILE"); NEW_SIZE=$(stat -c%s "$OUTPUT_FILE")
        DIFF=$((OLD_SIZE - NEW_SIZE))
        [ $OLD_SIZE -gt 0 ] && PCT=$(( 100 * DIFF / OLD_SIZE )) || PCT=0
        log_notify "Готово: $FILENAME\nСжато на $PCT% ($(du -h "$OUTPUT_FILE" | cut -f1))" "gui"
    else log_notify "Ошибка обработки: $FILENAME" "error"; fi

    [ "$IS_TEMP_PDF" = true ] && [ -f "$WORKING_FILE" ] && rm "$WORKING_FILE"
done
